<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Teacher Panel - DCS</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <!-- Firebase configuration (this must come before custom script) -->
  <script src="firebase.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header class="topbar">
    <img src="https://via.placeholder.com/80x80.png?text=Logo" alt="Logo">
    <h2>Teacher Panel</h2>
  </header>

  <main class="container">
    <h2 id="classTitle">Loading classroom...</h2>

    <!-- Marks Section -->
    <section class="card">
      <h3>Enter Student Marks</h3>
      <select id="examSelect">
        <option value="">-- Select Exam --</option>
        <option>PeriodicTest1</option>
        <option>HalfYearly</option>
        <option>PeriodicTest3</option>
        <option>Annual</option>
      </select>
      <div id="marksArea" class="loading">Loading students...</div>
      <button class="btn" id="saveMarksBtn">Save Marks</button>
      <canvas id="marksChart" width="400" height="200" style="display:none;"></canvas>
      <div id="marksAnalytics"></div>
    </section>

    <!-- Timetable Section -->
    <section class="card">
      <h3>Timetable (8 periods + Lunch after 4th)</h3>
      <div id="timetableArea"></div>
      <button class="btn" id="saveTimetableBtn">Save Timetable</button>
    </section>

    <!-- Attendance Section -->
    <section class="card">
      <h3>Attendance</h3>
      <label for="attendanceDate">Select Date:</label>
      <input type="date" id="attendanceDate" value="">
      <div id="attendanceArea" class="loading">Loading...</div>
      <button class="btn" id="saveAttendanceBtn">Save Today's Attendance</button>
    </section>

    <!-- Photos Section -->
    <section class="card">
      <h3>Class Activity Photos</h3>
      <input type="file" id="activityPhoto" multiple accept="image/*">
      <button class="btn" id="uploadPhotoBtn">Upload</button>
      <div id="photoGallery"></div>
    </section>
  </main>

  <footer class="footer"><a href="index.html" class="btn">Logout</a></footer>

  <script>
    // === GET CLASS NAME FROM URL ===
    const params = new URLSearchParams(window.location.search);
    const className = params.get("class") || "Unknown";
    document.getElementById("classTitle").innerText = `Classroom: ${className}`;

    // === FIREBASE REFERENCES ===
    const marksRef = db.ref(`schools/dilasagram/classes/${className}/marks`);
    const timetableRef = db.ref(`schools/dilasagram/classes/${className}/timetable`);
    const attendanceRef = db.ref(`schools/dilasagram/classes/${className}/attendance`);
    const activityRef = db.ref(`schools/dilasagram/classes/${className}/activities`);
    const studentsRef = db.ref(`schools/dilasagram/classes/${className}/students`);
    const storage = firebase.storage();

    let studentList = [];
    let marksChart = null;
    let saveTimeout;

    // === LOAD STUDENTS ===
    studentsRef.once("value").then((snap) => {
      const data = snap.val() || {};
      studentList = Object.keys(data);
      renderMarksArea();
      renderAttendance(true);
    }).catch(err => {
      alert("âŒ Failed to load classroom data: " + err.message);
      console.error(err);
    });

    // === MARKS ENTRY ===
    function renderMarksArea(exam = null) {
      const area = document.getElementById("marksArea");
      area.innerHTML = "";
      studentList.forEach(name => {
        const div = document.createElement("div");
        div.className = "studentRow";
        div.innerHTML = `
          <h4>${name}</h4>
          <input type="number" placeholder="English" id="${name}-English" min="0" max="100">
          <input type="number" placeholder="Maths" id="${name}-Maths" min="0" max="100">
          <input type="number" placeholder="Science" id="${name}-Science" min="0" max="100">
          <input type="number" placeholder="SocialScience" id="${name}-SS" min="0" max="100">
          <input type="number" placeholder="Hindi" id="${name}-Hindi" min="0" max="100">
          <input type="number" placeholder="Marathi" id="${name}-Marathi" min="0" max="100">
        `;
        area.appendChild(div);
      });
      if (exam) loadMarksForExam(exam);
    }

    document.getElementById("examSelect").addEventListener("change", (e) => {
      const exam = e.target.value;
      localStorage.setItem("lastExam", exam);
      if (exam) loadMarksForExam(exam);
    });

    function loadMarksForExam(exam) {
      marksRef.child(exam).once("value").then((snap) => {
        const data = snap.val() || {};
        studentList.forEach(name => {
          const marks = data[name] || {};
          ["English", "Maths", "Science", "SS", "Hindi", "Marathi"].forEach(subj => {
            const input = document.getElementById(`${name}-${subj}`);
            if (input) input.value = marks[subj] || "";
          });
        });
        renderAnalyticsAndChart(data, exam);
      });
    }

    document.getElementById("saveMarksBtn").onclick = () => {
      const exam = document.getElementById("examSelect").value;
      if (!exam) return alert("Select exam first");
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        const data = {};
        studentList.forEach(name => {
          data[name] = {};
          ["English", "Maths", "Science", "SS", "Hindi", "Marathi"].forEach(subj => {
            const input = document.getElementById(`${name}-${subj}`);
            data[name][subj] = parseInt(input.value) || 0;
          });
        });
        marksRef.child(exam).set(data).then(() => {
          alert("âœ… Marks saved successfully!");
          renderAnalyticsAndChart(data, exam);
        }).catch(err => alert("Save failed: " + err.message));
      }, 500);
    };

    function renderAnalyticsAndChart(data, exam) {
      let totalPerc = 0, count = 0;
      let html = "<h4>ðŸ“Š Marks Analytics</h4>";
      studentList.forEach(name => {
        const subs = Object.values(data[name] || {});
        const total = subs.reduce((a,b)=>a+b,0);
        const percent = (total/(subs.length*100))*100;
        totalPerc += percent; count++;
        html += `<p><b>${name}</b>: ${percent.toFixed(2)}%</p>`;
      });
      if (count > 0) html += `<p><b>Class Average:</b> ${(totalPerc/count).toFixed(2)}%</p>`;
      document.getElementById("marksAnalytics").innerHTML = html;

      const ctx = document.getElementById("marksChart");
      if (!ctx) return;
      const averages = studentList.map(name=>{
        const subs=Object.values(data[name]||{});
        return (subs.reduce((a,b)=>a+b,0)/(subs.length*100))*100;
      });
      if (marksChart) marksChart.destroy();
      ctx.style.display="block";
      marksChart = new Chart(ctx.getContext("2d"),{
        type:'bar',
        data:{
          labels:studentList,
          datasets:[{label:`${exam} %`,data:averages,backgroundColor:studentList.map(()=>`hsl(${Math.random()*360},70%,60%)`)}]
        },
        options:{
          responsive:true,
          scales:{y:{beginAtZero:true,max:100}},
          plugins:{title:{display:true,text:`ðŸ“Š ${exam} Marks Percentage`}}
        }
      });
    }

    // === TIMETABLE ===
    const periods=["1","2","3","4","Lunch","5","6","7","8"];
    const timetableArea=document.getElementById("timetableArea");
    periods.forEach(p=>{
      const div=document.createElement("div");
      div.innerHTML=`<label>Period ${p}:</label><input id="period${p}">`;
      timetableArea.appendChild(div);
    });

    timetableRef.once("value").then(snap=>{
      const data=snap.val()||{};
      periods.forEach(p=>{
        const input=document.getElementById(`period${p}`);
        if(input) input.value=data[`period${p}`]||"";
      });
    });

    document.getElementById("saveTimetableBtn").onclick=()=>{
      const updates={};
      periods.forEach(p=>updates[`period${p}`]=document.getElementById(`period${p}`).value||"");
      timetableRef.set(updates).then(()=>alert("Timetable saved âœ…"));
    };

    // === ATTENDANCE ===
    const attendanceDate=document.getElementById("attendanceDate");
    attendanceDate.value=new Date().toISOString().split('T')[0];
    attendanceDate.onchange=()=>renderAttendance(true);

    function renderAttendance(loadFromDB=false){
      const date=attendanceDate.value;
      const area=document.getElementById("attendanceArea");
      attendanceRef.child(date).once("value").then(snap=>{
        const records=snap.val()||{};
        let html=`<table class="attendance-table"><tr><th>Student</th><th>Present</th><th>Status</th></tr>`;
        studentList.forEach(name=>{
          const status=records[name]||"Absent";
          html+=`<tr><td>${name}</td><td><input type="checkbox" id="att-${name}" ${status==="Present"?"checked":""} onchange="updateAttendance('${name}','${date}')"></td><td>${status}</td></tr>`;
        });
        html+="</table>";
        area.innerHTML=html;
      });
    }

    window.updateAttendance=(name,date)=>{
      const chk=document.getElementById(`att-${name}`);
      const status=chk.checked?"Present":"Absent";
      attendanceRef.child(date).child(name).set(status);
    };

    document.getElementById("saveAttendanceBtn").onclick=()=>alert("Attendance auto-saves on change âœ…");

    // === PHOTOS UPLOAD ===
    document.getElementById("uploadPhotoBtn").onclick=async()=>{
      const files=document.getElementById("activityPhoto").files;
      if(!files.length) return alert("Select images first");
      const gallery=document.getElementById("photoGallery");
      gallery.innerHTML='<div class="spinner"></div> Uploading...';
      for(const f of files){
        const ref=storage.ref(`activities/${className}/${Date.now()}-${f.name}`);
        await ref.put(f);
        const url=await ref.getDownloadURL();
        await activityRef.push({url,name:f.name,time:new Date().toLocaleString()});
        await db.ref(`schools/dilasagram/public/gallery`).push({url,name:f.name,uploadedBy:className,time:new Date().toLocaleString()});
      }
      alert("Photos uploaded âœ…");
      loadPhotoGallery();
    };

    function loadPhotoGallery(){
      activityRef.once("value").then(snap=>{
        const data=snap.val()||{};
        const gallery=document.getElementById("photoGallery");
        gallery.innerHTML="";
        Object.values(data).slice(-10).forEach(p=>{
          const img=document.createElement("img");
          img.src=p.url;
          img.className="gallery-img";
          gallery.appendChild(img);
        });
      });
    }
    loadPhotoGallery();

    // === LAST EXAM AUTO-LOAD ===
    const lastExam=localStorage.getItem("lastExam");
    if(lastExam) document.getElementById("examSelect").value=lastExam;
  </script>
</body>
</html>
